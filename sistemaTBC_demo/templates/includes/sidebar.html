<!-- templates/includes/sidebar.html -->
<nav class="sidebar border-end p-3">
    <div class="sidebar-content">
        <div class="sidebar-header mb-4 text-center">
            <h5 class="fw-bold">
                <i class="fas fa-lungs me-2"></i>SistemaTBC
            </h5>
            <small class="text-light opacity-75">Gestión de Tuberculosis</small>
        </div>

        <div class="sidebar-user text-center mb-4">
            <div class="avatar-circle bg-light mx-auto mb-2 d-flex align-items-center justify-content-center">
                <i class="fas fa-user text-primary"></i>
            </div>
            <h6 class="mb-1 text-white">{{ user.get_full_name|default:user.username }}</h6>
            <small class="text-light opacity-75">
                {% if user.usuariosusuario %}
                    {{ user.usuariosusuario.get_rol_display }}
                {% elif user.is_superuser %}
                    Superusuario
                {% else %}
                    Usuario
                {% endif %}
            </small>
            <br>
            {% if user.usuariosusuario %}
            <small class="text-light opacity-75">{{ user.usuariosusuario.establecimiento }}</small>
            {% endif %}
        </div>

        <div class="sidebar-menu">
            <ul class="nav nav-pills flex-column">
                <!-- Dashboard (siempre visible) -->
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                       href="{% url 'usuarios:dashboard' %}">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>

                <!-- API REST (todos los usuarios autenticados) -->
                {% if user.is_authenticated %}
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if '/api/' in request.path %}active{% endif %}" 
                       href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-code me-2"></i> API REST
                    </a>
                    <ul class="dropdown-menu">
                        <!-- Dashboard API -->
                        <li>
                            <a class="dropdown-item {% if '/api/dashboard/' in request.path %}active{% endif %}" 
                               href="{% url 'swagger-ui' %}">
                                <i class="fas fa-chart-bar me-2"></i>Documentación API
                            </a>
                        </li>
                        
                        <!-- API Pacientes -->
                        {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico,enfermera,tecnologo,paramedico' %}
                        <li>
                            <a class="dropdown-item {% if '/api/pacientes/' in request.path and not '/api/pacientes/' == '/api/pacientes/'|add:'?format=api' %}active{% endif %}" 
                               href="/api/pacientes/" target="_blank">
                                <i class="fas fa-user-injured me-2"></i>API Pacientes
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- API Tratamientos -->
                        {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico,enfermera,paramedico' %}
                        <li>
                            <a class="dropdown-item {% if '/api/tratamientos/' in request.path %}active{% endif %}" 
                               href="/api/tratamientos/" target="_blank">
                                <i class="fas fa-pills me-2"></i>API Tratamientos
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- API Dashboard -->
                        {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico,enfermera,tecnologo' %}
                        <li>
                            <a class="dropdown-item {% if '/api/dashboard/' in request.path %}active{% endif %}" 
                               href="/api/dashboard/estadisticas/" target="_blank">
                                <i class="fas fa-chart-pie me-2"></i>Dashboard API
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- API Externa: Clima -->
                        {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico,enfermera' %}
                        <li>
                            <a class="dropdown-item {% if '/api/external/clima/' in request.path %}active{% endif %}" 
                               href="/api/external/clima/?ciudad=Santiago" target="_blank">
                                <i class="fas fa-cloud-sun me-2"></i>API Clima
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- API Externa: Geocodificación -->
                        {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico,enfermera,paramedico' %}
                        <li>
                            <a class="dropdown-item {% if '/api/external/geocodificar/' in request.path %}active{% endif %}" 
                               href="/api/external/geocodificar/" target="_blank">
                                <i class="fas fa-map-marker-alt me-2"></i>Geocodificación
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- API Externa: Análisis Epidemiológico -->
                        {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico' %}
                        <li>
                            <a class="dropdown-item {% if '/api/external/analisis-epidemiologico/' in request.path %}active{% endif %}" 
                               href="/api/external/analisis-epidemiologico/?comuna=Santiago" target="_blank">
                                <i class="fas fa-chart-line me-2"></i>Análisis Epidemiológico
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- Estado de APIs -->
                        <li>
                            <a class="dropdown-item {% if '/api/status/' in request.path %}active{% endif %}" 
                               href="/api/status/" target="_blank">
                                <i class="fas fa-server me-2"></i>Estado del Sistema
                            </a>
                        </li>
                        
                        <!-- Interfaz API Testing -->
                        <li>
                            <a class="dropdown-item {% if '/api/dashboard/' in request.path and 'dashboard.html' in request.path %}active{% endif %}" 
                               href="/api/dashboard/" target="_blank">
                                <i class="fas fa-vial me-2"></i>Probar APIs
                            </a>
                        </li>
                        
                        <!-- Documentación Swagger -->
                        <li>
                            <a class="dropdown-item {% if '/api/docs/' in request.path %}active{% endif %}" 
                               href="/api/docs/" target="_blank">
                                <i class="fas fa-book me-2"></i>Documentación Swagger
                            </a>
                        </li>
                        
                        <!-- Documentación ReDoc -->
                        <li>
                            <a class="dropdown-item {% if '/api/redoc/' in request.path %}active{% endif %}" 
                               href="/api/redoc/" target="_blank">
                                <i class="fas fa-book-open me-2"></i>Documentación ReDoc
                            </a>
                        </li>
                    </ul>
                </li>
                {% endif %}

                <!-- Módulo Usuarios (Solo administradores) -->
                {% if user.is_superuser or user.usuariosusuario.rol == 'admin' %}
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.namespace == 'usuarios' and request.resolver_match.url_name != 'dashboard' and request.resolver_match.url_name != 'perfil' and request.resolver_match.url_name != 'cambiar_password' %}active{% endif %}" 
                       href="{% url 'usuarios:lista' %}">
                        <i class="fas fa-users"></i> Usuarios
                    </a>
                </li>
                {% endif %}

                <!-- Módulo Pacientes (todos los roles excepto algunos) -->
                {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico,enfermera,tecnologo,paramedico' %}
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.namespace == 'pacientes' %}active{% endif %}" 
                       href="{% url 'pacientes:lista' %}">
                        <i class="fas fa-user-injured"></i> Pacientes
                    </a>
                </li>
                {% endif %}

                <!-- Módulo Tratamientos (roles clínicos) -->
                {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico,enfermera,paramedico' %}
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.namespace == 'tratamientos' %}active{% endif %}" 
                       href="{% url 'tratamientos:lista' %}">
                        <i class="fas fa-pills"></i> Tratamientos
                    </a>
                </li>
                {% endif %}

                <!-- Módulo Exámenes (médicos, tecnólogos y administradores) -->
                {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico,tecnologo,enfermera' %}
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.namespace == 'examenes' %}active{% endif %}" 
                       href="{% url 'examenes:lista_examenes' %}">
                        <i class="fas fa-microscope"></i> Exámenes
                    </a>
                </li>
                {% endif %}

                <!-- Módulo Contactos (roles de campo y clínicos) -->
                {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico,enfermera,paramedico' %}
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.namespace == 'contactos' %}active{% endif %}" 
                       href="{% url 'contactos:lista' %}">
                        <i class="fas fa-people-arrows"></i> Contactos
                    </a>
                </li>
                {% endif %}

                <!-- Módulo Prevención (enfermeras, paramédicos y administradores) -->
                {% if user.is_superuser or user.usuariosusuario.rol in 'admin,enfermera,paramedico' %}
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.namespace == 'prevencion' %}active{% endif %}" 
                       href="{% url 'prevencion:quimioprofilaxis_lista' %}">
                        <i class="fas fa-shield-virus"></i> Prevención
                    </a>
                </li>
                {% endif %}

                <!-- Módulo Laboratorio (solo tecnólogos y administradores) -->
                {% if user.is_superuser or user.usuariosusuario.rol in 'admin,tecnologo' %}
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.namespace == 'laboratorio' %}active{% endif %}" 
                       href="{% url 'laboratorio:laboratorios_lista' %}">
                        <i class="fas fa-flask"></i> Laboratorio
                    </a>
                </li>
                {% endif %}

                <!-- Módulo Indicadores (roles específicos con acceso) -->
                {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico,enfermera,tecnologo' %}
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if request.resolver_match.namespace == 'indicadores' %}active{% endif %}" 
                       href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-chart-bar"></i> Indicadores
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                               href="{% url 'indicadores:dashboard' %}">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard Principal
                            </a>
                        </li>
                        
                        <!-- Solo médicos y administradores -->
                        {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico' %}
                        <li>
                            <a class="dropdown-item {% if request.resolver_match.url_name == 'indicadores_cohorte' %}active{% endif %}" 
                               href="{% url 'indicadores:indicadores_cohorte' %}">
                                <i class="fas fa-chart-line me-2"></i>Indicadores Cohorte
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- Médicos, enfermeras y administradores -->
                        {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico,enfermera' %}
                        <li>
                            <a class="dropdown-item {% if request.resolver_match.url_name == 'indicadores_operacionales' %}active{% endif %}" 
                               href="{% url 'indicadores:indicadores_operacionales' %}">
                                <i class="fas fa-cogs me-2"></i>Indicadores Operacionales
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- Enfermeras y administradores -->
                        {% if user.is_superuser or user.usuariosusuario.rol in 'admin,enfermera' %}
                        <li>
                            <a class="dropdown-item {% if request.resolver_match.url_name == 'indicadores_prevencion' %}active{% endif %}" 
                               href="{% url 'indicadores:indicadores_prevencion' %}">
                                <i class="fas fa-shield-alt me-2"></i>Indicadores Prevención
                            </a>
                        </li>
                        {% endif %}
                        
                        <!-- Todos los roles autorizados -->
                        <li>
                            <a class="dropdown-item {% if request.resolver_match.url_name == 'alertas_lista' %}active{% endif %}" 
                               href="{% url 'indicadores:alertas_lista' %}">
                                <i class="fas fa-bell me-2"></i>Sistema de Alertas
                            </a>
                        </li>
                        
                        <!-- Solo administradores y médicos -->
                        {% if user.is_superuser or user.usuariosusuario.rol in 'admin,medico' %}
                        <li>
                            <a class="dropdown-item {% if request.resolver_match.url_name == 'reportes_gerenciales' %}active{% endif %}" 
                               href="{% url 'indicadores:reportes_gerenciales' %}">
                                <i class="fas fa-file-export me-2"></i>Reportes Gerenciales
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- Administración Django (solo superusuarios) -->
                {% if user.is_superuser %}
                <li class="nav-item">
                    <a class="nav-link" href="/admin/" target="_blank">
                        <i class="fas fa-cogs"></i> Admin Django
                    </a>
                </li>
                {% endif %}

                <!-- Perfil (siempre visible) -->
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.url_name == 'perfil' %}active{% endif %}" 
                       href="{% url 'usuarios:perfil' user.usuariosusuario.pk %}">
                        <i class="fas fa-user-cog"></i> Mi Perfil
                    </a>
                </li>
            </ul>
        </div>

        <div class="sidebar-footer mt-auto pt-3 border-top border-light opacity-50">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-light opacity-75">
                    <i class="fas fa-info-circle me-1"></i>
                    {{ user.usuariosusuario.establecimiento|default:"Sistema TBC" }}
                </small>
                {% if user.is_authenticated %}
                <small class="text-light opacity-75">
                    <i class="fas fa-code me-1"></i>
                    API v1.0
                </small>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

<style>
    .sidebar {
        height: 100vh;
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        position: fixed;
        left: 0;
        top: 0;
        width: 280px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
    }

    .sidebar-content {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }

    .sidebar-header {
        flex-shrink: 0;
    }

    .sidebar-user {
        flex-shrink: 0;
    }

    .sidebar-menu {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 5px;
    }

    .sidebar-menu::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar-menu::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
    }

    .sidebar-menu::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
    }

    .sidebar-menu::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }

    .sidebar-footer {
        flex-shrink: 0;
    }

    .avatar-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        font-size: 1.5rem;
    }

    .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        margin-bottom: 4px;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }

    .sidebar .nav-link:hover {
        color: white;
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
    }

    .sidebar .nav-link.active {
        color: white;
        background: rgba(52, 152, 219, 0.3);
        border-left: 4px solid #3498db;
    }

    .sidebar .nav-link i {
        width: 20px;
        margin-right: 10px;
    }

    /* Estilos específicos para API REST */
    .sidebar .nav-link[href*="/api/"] {
        background: rgba(155, 89, 182, 0.2);
        border-left: 4px solid #9b59b6;
    }

    .sidebar .nav-link[href*="/api/"]:hover,
    .sidebar .nav-link[href*="/api/"].active {
        background: rgba(155, 89, 182, 0.4);
    }

    .sidebar .dropdown-menu {
        background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        border: none;
        border-radius: 8px;
        margin-left: 10px;
        min-width: 250px;
    }

    .sidebar .dropdown-item {
        color: rgba(255, 255, 255, 0.8);
        padding: 8px 15px;
        border-radius: 5px;
        margin: 2px 5px;
        transition: all 0.3s ease;
    }

    .sidebar .dropdown-item:hover {
        color: white;
        background: rgba(52, 152, 219, 0.3);
    }

    .sidebar .dropdown-item.active {
        color: white;
        background: rgba(52, 152, 219, 0.5);
    }

    /* Estilos específicos para items de API */
    .sidebar .dropdown-item[href*="/api/"] {
        border-left: 3px solid #9b59b6;
    }

    .sidebar .dropdown-item[href*="/docs/"],
    .sidebar .dropdown-item[href*="/redoc/"] {
        border-left: 3px solid #f39c12;
    }

    .sidebar .dropdown-item[href*="/status/"] {
        border-left: 3px solid #2ecc71;
    }

    .sidebar .dropdown-toggle::after {
        margin-left: auto;
    }

    /* Indicador de API activa */
    .api-active-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: #2ecc71;
        border-radius: 50%;
        margin-left: 5px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
        }
        70% {
            transform: scale(1);
            box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
        }
        100% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
        }
    }
</style>

<script>
// Script para verificar estado de APIs y mostrar indicador
document.addEventListener('DOMContentLoaded', function() {
    // Verificar estado de APIs cada 30 segundos
    function checkAPIStatus() {
        fetch('/api/status/')
            .then(response => response.json())
            .then(data => {
                const apiStatusElement = document.getElementById('api-status-indicator');
                if (apiStatusElement) {
                    if (data.api_rest && data.base_datos) {
                        apiStatusElement.style.backgroundColor = '#2ecc71'; // Verde
                        apiStatusElement.title = 'APIs funcionando correctamente';
                    } else {
                        apiStatusElement.style.backgroundColor = '#e74c3c'; // Rojo
                        apiStatusElement.title = 'Algunas APIs no están disponibles';
                    }
                }
            })
            .catch(error => {
                console.log('No se pudo verificar estado de APIs');
            });
    }

    // Agregar indicador visual al menú API
    const apiMenuLink = document.querySelector('.nav-link[href*="/api/"]');
    if (apiMenuLink) {
        const indicator = document.createElement('span');
        indicator.id = 'api-status-indicator';
        indicator.className = 'api-active-indicator';
        indicator.title = 'Verificando estado de APIs...';
        apiMenuLink.appendChild(indicator);
        
        // Verificar estado inicial
        checkAPIStatus();
        
        // Verificar periódicamente
        setInterval(checkAPIStatus, 30000);
    }

    // Abrir enlaces API en nueva pestaña
    document.querySelectorAll('.dropdown-item[href*="/api/"]').forEach(link => {
        link.addEventListener('click', function(e) {
            // Solo abrir en nueva pestaña si no es Ctrl+click
            if (!e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                window.open(this.href, '_blank');
            }
        });
    });
});
</script>