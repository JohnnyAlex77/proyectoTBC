{% extends 'base.html' %}
{% load static %}

{% block title %}Sistema de Alertas - SISTEMA TBC{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Sistema de Alertas y Notificaciones</h1>
        <div class="btn-group">
            <button class="btn btn-primary" data-toggle="modal" data-target="#nuevaAlertaModal">
                <i class="fas fa-plus fa-sm"></i> Nueva Alerta
            </button>
            <button class="btn btn-outline-primary" id="btnFiltrarAlertas">
                <i class="fas fa-filter fa-sm"></i> Filtrar
            </button>
        </div>
    </div>

    <!-- Filtros R치pidos -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="font-weight-bold">Tipo de Alerta</label>
                            <select class="form-control filtro-alerta" data-filtro="tipo">
                                <option value="">Todos los tipos</option>
                                <option value="VENCIMIENTO">Vencimientos</option>
                                <option value="RESULTADO">Resultados</option>
                                <option value="SEGUIMIENTO">Seguimientos</option>
                                <option value="EPIDEMIOLOGICA">Epidemiol칩gicas</option>
                                <option value="CALIDAD">Calidad de Datos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="font-weight-bold">Nivel</label>
                            <select class="form-control filtro-alerta" data-filtro="nivel">
                                <option value="">Todos los niveles</option>
                                <option value="BAJA">Baja</option>
                                <option value="MEDIA">Media</option>
                                <option value="ALTA">Alta</option>
                                <option value="CRITICA">Cr칤tica</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="font-weight-bold">Estado</label>
                            <select class="form-control filtro-alerta" data-filtro="estado">
                                <option value="">Todos</option>
                                <option value="pendientes">Solo Pendientes</option>
                                <option value="resueltas">Solo Resueltas</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="font-weight-bold">Establecimiento</label>
                            <select class="form-control filtro-alerta" data-filtro="establecimiento">
                                <option value="">Todos</option>
                                {% for estab in establecimientos %}
                                <option value="{{ estab.id }}">{{ estab.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estad칤sticas R치pidas -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Cr칤ticas
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ alertas_criticas }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Altas
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ alertas_altas }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Pendientes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ alertas_pendientes }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Resueltas (7d)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ alertas_resueltas_7d }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-md-8 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Tiempo Promedio Resoluci칩n
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ tiempo_promedio_resolucion }} d칤as</div>
                            <div class="text-xs text-muted">칔ltimos 30 d칤as</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-stopwatch fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Alertas -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        游늶 Lista de Alertas 
                        <span class="badge badge-primary">{{ alertas|length }}</span>
                    </h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" 
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" 
                             aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Acciones:</div>
                            <a class="dropdown-item" href="#" id="marcarTodasLeidas">
                                <i class="fas fa-check-double fa-fw"></i> Marcar todas como le칤das
                            </a>
                            <a class="dropdown-item" href="#" id="exportarAlertas">
                                <i class="fas fa-file-export fa-fw"></i> Exportar a Excel
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#configAlertasModal">
                                <i class="fas fa-cog fa-fw"></i> Configurar Alertas
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if alertas %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="tablaAlertas" width="100%" cellspacing="0">
                            <thead class="thead-light">
                                <tr>
                                    <th width="5%"></th>
                                    <th width="10%">Tipo</th>
                                    <th width="10%">Nivel</th>
                                    <th width="25%">Descripci칩n</th>
                                    <th width="15%">Establecimiento</th>
                                    <th width="10%">Asignado a</th>
                                    <th width="10%">Creada</th>
                                    <th width="10%">Vence</th>
                                    <th width="5%">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alerta in alertas %}
                                <tr class="{% if alerta.resuelta %}table-success{% else %}alerta-fila alerta-{{ alerta.nivel|lower }}{% endif %}">
                                    <td class="text-center">
                                        {% if not alerta.resuelta %}
                                        <span class="badge badge-{{ alerta.nivel|lower }} pulsante">
                                            <i class="fas fa-bell"></i>
                                        </span>
                                        {% else %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-check"></i>
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-light border">
                                            {{ alerta.get_tipo_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge badge-{{ alerta.nivel|lower }}">
                                            {{ alerta.get_nivel_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong>{{ alerta.titulo }}</strong>
                                        <br>
                                        <small class="text-muted">{{ alerta.descripcion|truncatewords:10 }}</small>
                                    </td>
                                    <td>{{ alerta.establecimiento.nombre }}</td>
                                    <td>
                                        {% if alerta.usuario_asignado %}
                                        {{ alerta.usuario_asignado.get_full_name|default:alerta.usuario_asignado.username }}
                                        {% else %}
                                        <span class="text-muted">Sin asignar</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ alerta.fecha_creacion|date:"d/m/Y" }}</small>
                                        <br>
                                        <small class="text-muted">{{ alerta.fecha_creacion|timesince }}</small>
                                    </td>
                                    <td>
                                        {% if not alerta.resuelta %}
                                            {% if alerta.esta_vencida %}
                                            <span class="badge badge-danger">Vencida</span>
                                            {% else %}
                                            <small>{{ alerta.fecha_vencimiento|date:"d/m/Y" }}</small>
                                            <br>
                                            <small class="text-muted">en {{ alerta.fecha_vencimiento|timeuntil }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge badge-secondary">Resuelta</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-info btn-sm ver-alerta" 
                                                    data-alerta-id="{{ alerta.id }}"
                                                    title="Ver detalles">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if not alerta.resuelta %}
                                            <button class="btn btn-success btn-sm resolver-alerta" 
                                                    data-alerta-id="{{ alerta.id }}"
                                                    title="Marcar como resuelta">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-danger btn-sm eliminar-alerta" 
                                                    data-alerta-id="{{ alerta.id }}"
                                                    title="Eliminar alerta">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-bell-slash fa-4x text-gray-300 mb-3"></i>
                        <h4 class="text-gray-500">No hay alertas para mostrar</h4>
                        <p class="text-muted">Todas las alertas est치n gestionadas o no hay nuevas notificaciones.</p>
                        <button class="btn btn-primary mt-3" data-toggle="modal" data-target="#nuevaAlertaModal">
                            <i class="fas fa-plus fa-sm"></i> Crear Primera Alerta
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Alerta -->
<div class="modal fade" id="nuevaAlertaModal" tabindex="-1" role="dialog" aria-labelledby="nuevaAlertaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nuevaAlertaModalLabel">Crear Nueva Alerta</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="formNuevaAlerta" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="tipoAlerta">Tipo de Alerta *</label>
                                <select class="form-control" id="tipoAlerta" name="tipo" required>
                                    <option value="">Seleccionar tipo...</option>
                                    <option value="VENCIMIENTO">Vencimiento</option>
                                    <option value="RESULTADO">Resultado</option>
                                    <option value="SEGUIMIENTO">Seguimiento</option>
                                    <option value="EPIDEMIOLOGICA">Alerta Epidemiol칩gica</option>
                                    <option value="CALIDAD">Calidad de Datos</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="nivelAlerta">Nivel de Urgencia *</label>
                                <select class="form-control" id="nivelAlerta" name="nivel" required>
                                    <option value="">Seleccionar nivel...</option>
                                    <option value="BAJA">Baja</option>
                                    <option value="MEDIA">Media</option>
                                    <option value="ALTA">Alta</option>
                                    <option value="CRITICA">Cr칤tica</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tituloAlerta">T칤tulo *</label>
                        <input type="text" class="form-control" id="tituloAlerta" name="titulo" 
                               placeholder="Ej: Vencimiento de tratamiento - Paciente Juan P칠rez" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="descripcionAlerta">Descripci칩n Detallada *</label>
                        <textarea class="form-control" id="descripcionAlerta" name="descripcion" 
                                  rows="4" placeholder="Describa los detalles de la alerta..." required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="establecimientoAlerta">Establecimiento *</label>
                                <select class="form-control" id="establecimientoAlerta" name="establecimiento" required>
                                    <option value="">Seleccionar establecimiento...</option>
                                    {% for estab in establecimientos %}
                                    <option value="{{ estab.id }}">{{ estab.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="usuarioAsignado">Asignar a</label>
                                <select class="form-control" id="usuarioAsignado" name="usuario_asignado">
                                    <option value="">Sin asignar</option>
                                    {% for usuario in usuarios %}
                                    <option value="{{ usuario.id }}">{{ usuario.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="fechaVencimiento">Fecha de Vencimiento *</label>
                        <input type="datetime-local" class="form-control" id="fechaVencimiento" 
                               name="fecha_vencimiento" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Alerta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Configuraci칩n Alertas -->
<div class="modal fade" id="configAlertasModal" tabindex="-1" role="dialog" aria-labelledby="configAlertasModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configAlertasModalLabel">丘뙖잺 Configuraci칩n de Alertas</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formConfigAlertas">
                    <div class="form-group">
                        <label>Notificaciones por Email</label>
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="notificacionesEmail" checked>
                            <label class="custom-control-label" for="notificacionesEmail">
                                Recibir notificaciones por correo electr칩nico
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Recordatorios Diarios</label>
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="recordatoriosDiarios" checked>
                            <label class="custom-control-label" for="recordatoriosDiarios">
                                Enviar resumen diario de alertas pendientes
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="umbralCritico">Umbral para Alertas Cr칤ticas (d칤as)</label>
                        <input type="number" class="form-control" id="umbralCritico" value="1" min="1" max="7">
                        <small class="form-text text-muted">
                            Las alertas se consideran cr칤ticas cuando faltan menos de X d칤as para su vencimiento
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="guardarConfigAlertas">
                    <i class="fas fa-save"></i> Guardar Configuraci칩n
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.alerta-fila {
    border-left: 4px solid transparent;
}
.alerta-fila.alerta-critica {
    border-left-color: #e74a3b;
    background-color: #f8d7da;
}
.alerta-fila.alerta-alta {
    border-left-color: #f6c23e;
    background-color: #fff3cd;
}
.alerta-fila.alerta-media {
    border-left-color: #36b9cc;
    background-color: #d1ecf1;
}
.alerta-fila.alerta-baja {
    border-left-color: #1cc88a;
    background-color: #d1f2eb;
}

.pulsante {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.badge-critica { background-color: #e74a3b; }
.badge-alta { background-color: #f6c23e; }
.badge-media { background-color: #36b9cc; }
.badge-baja { background-color: #1cc88a; }

.table-hover tbody tr:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Filtros en tiempo real
    $('.filtro-alerta').change(function() {
        filtrarAlertas();
    });

    // Resolver alerta
    $('.resolver-alerta').click(function() {
        const alertaId = $(this).data('alerta-id');
        resolverAlerta(alertaId);
    });

    // Eliminar alerta
    $('.eliminar-alerta').click(function() {
        const alertaId = $(this).data('alerta-id');
        eliminarAlerta(alertaId);
    });

    // Ver detalles de alerta
    $('.ver-alerta').click(function() {
        const alertaId = $(this).data('alerta-id');
        verDetallesAlerta(alertaId);
    });

    // Configuraci칩n
    $('#guardarConfigAlertas').click(function() {
        guardarConfiguracion();
    });

    // Nueva alerta
    $('#formNuevaAlerta').submit(function(e) {
        e.preventDefault();
        crearNuevaAlerta();
    });
});

function filtrarAlertas() {
    // Implementar filtrado de alertas
    console.log('Filtrando alertas...');
}

function resolverAlerta(alertaId) {
    if (confirm('쮼st치 seguro de marcar esta alerta como resuelta?')) {
        // Implementar llamada AJAX para resolver alerta
        console.log('Resolviendo alerta:', alertaId);
    }
}

function eliminarAlerta(alertaId) {
    if (confirm('쮼st치 seguro de eliminar esta alerta? Esta acci칩n no se puede deshacer.')) {
        // Implementar llamada AJAX para eliminar alerta
        console.log('Eliminando alerta:', alertaId);
    }
}

function verDetallesAlerta(alertaId) {
    // Implementar modal de detalles
    console.log('Viendo detalles de alerta:', alertaId);
}

function guardarConfiguracion() {
    // Implementar guardado de configuraci칩n
    console.log('Guardando configuraci칩n...');
    $('#configAlertasModal').modal('hide');
    showToast('success', 'Configuraci칩n guardada correctamente');
}

function crearNuevaAlerta() {
    // Implementar creaci칩n de nueva alerta
    console.log('Creando nueva alerta...');
    $('#nuevaAlertaModal').modal('hide');
    showToast('success', 'Alerta creada correctamente');
}

function showToast(type, message) {
    // Implementar notificaci칩n toast
    console.log('Toast:', type, message);
}
</script>
{% endblock %}