{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Paciente - Sistema TBC{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-12 col-lg-10">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Editar Paciente: {{ paciente.nombre }}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" novalidate id="paciente-form">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="border-bottom pb-2 mb-3 text-primary">
                                    <i class="fas fa-id-card me-2"></i>Datos Personales
                                </h5>
                                
                                <div class="mb-3">
                                    {{ form.rut.label_tag }}
                                    {{ form.rut }}
                                    {% for error in form.rut.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <div class="mb-3">
                                    {{ form.nombre.label_tag }}
                                    {{ form.nombre }}
                                    {% for error in form.nombre.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <div class="mb-3">
                                    {{ form.fecha_nacimiento.label_tag }}
                                    {{ form.fecha_nacimiento }}
                                    {% for error in form.fecha_nacimiento.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <div class="mb-3">
                                    {{ form.sexo.label_tag }}
                                    {{ form.sexo }}
                                    {% for error in form.sexo.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <div class="mb-3">
                                    {{ form.telefono.label_tag }}
                                    {{ form.telefono }}
                                    {% for error in form.telefono.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="border-bottom pb-2 mb-3 text-primary">
                                    <i class="fas fa-home me-2"></i>Dirección y Contacto
                                </h5>

                                <div class="mb-3">
                                    {{ form.domicilio.label_tag }}
                                    {{ form.domicilio }}
                                    {% for error in form.domicilio.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <div class="mb-3">
                                    {{ form.comuna.label_tag }}
                                    {{ form.comuna }}
                                    {% for error in form.comuna.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <div class="mb-3">
                                    {{ form.establecimiento_salud.label_tag }}
                                    {{ form.establecimiento_salud }}
                                    {% for error in form.establecimiento_salud.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h5 class="border-bottom pb-2 mb-3 text-primary">
                                    <i class="fas fa-stethoscope me-2"></i>Datos del Diagnóstico
                                </h5>

                                <div class="mb-3">
                                    {{ form.fecha_diagnostico.label_tag }}
                                    {{ form.fecha_diagnostico }}
                                    {% for error in form.fecha_diagnostico.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <div class="mb-3">
                                    {{ form.tipo_tbc.label_tag }}
                                    {{ form.tipo_tbc }}
                                    {% for error in form.tipo_tbc.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <div class="mb-3">
                                    {{ form.estado.label_tag }}
                                    {{ form.estado }}
                                    {% for error in form.estado.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="border-bottom pb-2 mb-3 text-primary">
                                    <i class="fas fa-flask me-2"></i>Exámenes de Laboratorio
                                </h5>

                                <div class="mb-3">
                                    {{ form.baciloscopia_inicial.label_tag }}
                                    {{ form.baciloscopia_inicial }}
                                    {% for error in form.baciloscopia_inicial.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <div class="mb-3">
                                    {{ form.cultivo_inicial.label_tag }}
                                    {{ form.cultivo_inicial }}
                                    {% for error in form.cultivo_inicial.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>

                                <div class="mb-3">
                                    {{ form.poblacion_prioritaria.label_tag }}
                                    {{ form.poblacion_prioritaria }}
                                    {% for error in form.poblacion_prioritaria.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-12">
                                <h5 class="border-bottom pb-2 mb-3 text-primary">
                                    <i class="fas fa-heartbeat me-2"></i>Antecedentes Médicos
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Enfermedades Preexistentes</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    {{ form.nueva_enfermedad.label_tag }}
                                                    <div class="input-group">
                                                        {{ form.nueva_enfermedad }}
                                                        <button type="button" class="btn btn-outline-primary" id="agregar-enfermedad">
                                                            <i class="fas fa-plus"></i> Agregar
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <div id="lista-enfermedades" class="mb-3">
                                                </div>
                                                
                                                {{ form.enfermedades_preexistentes }}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Alergias</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    {{ form.nueva_alergia.label_tag }}
                                                    <div class="input-group">
                                                        {{ form.nueva_alergia }}
                                                        <button type="button" class="btn btn-outline-primary" id="agregar-alergia">
                                                            <i class="fas fa-plus"></i> Agregar
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <div id="lista-alergias" class="mb-3">
                                                </div>
                                                
                                                {{ form.alergias }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'pacientes:lista' %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-save me-2"></i>
                                        Actualizar Paciente
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.border-bottom {
    border-color: #0d6efd !important;
}

.lista-item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.lista-item-text {
    flex-grow: 1;
    margin-right: 1rem;
}

.btn-eliminar-item {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
}

.btn-eliminar-item:hover {
    color: #bd2130;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let enfermedades = [];
    let alergias = [];
    
    const enfermedadInput = document.getElementById('nueva-enfermedad');
    const alergiaInput = document.getElementById('nueva-alergia');
    const agregarEnfermedadBtn = document.getElementById('agregar-enfermedad');
    const agregarAlergiaBtn = document.getElementById('agregar-alergia');
    const listaEnfermedades = document.getElementById('lista-enfermedades');
    const listaAlergias = document.getElementById('lista-alergias');
    const enfermedadesHidden = document.getElementById('enfermedades-input');
    const alergiasHidden = document.getElementById('alergias-input');
    const rutInput = document.getElementById('rut-input');
    
    function formatearRutInput(valor) {
        let rut = valor.replace(/[^0-9Kk\-]/g, '');
        
        if (rut.includes('-') || rut.length > 8) {
            let numero = rut.split('-')[0] || rut.slice(0, -1);
            let dv = rut.includes('-') ? rut.split('-')[1] : rut.slice(-1);
            
            let numeroFormateado = '';
            while (numero.length > 3) {
                numeroFormateado = '.' + numero.slice(-3) + numeroFormateado;
                numero = numero.slice(0, -3);
            }
            numeroFormateado = numero + numeroFormateado;
            
            return dv ? numeroFormateado + '-' + dv.toUpperCase() : numeroFormateado;
        }
        
        let numeroFormateado = '';
        let tempNumero = rut;
        while (tempNumero.length > 3) {
            numeroFormateado = '.' + tempNumero.slice(-3) + numeroFormateado;
            tempNumero = tempNumero.slice(0, -3);
        }
        numeroFormateado = tempNumero + numeroFormateado;
        
        return numeroFormateado;
    }
    
    if (rutInput) {
        rutInput.addEventListener('input', function(e) {
            let cursorPos = e.target.selectionStart;
            let valorOriginal = e.target.value;
            
            let valorFormateado = formatearRutInput(valorOriginal);
            
            e.target.value = valorFormateado;
            
            let diferencia = valorFormateado.length - valorOriginal.length;
            e.target.setSelectionRange(cursorPos + diferencia, cursorPos + diferencia);
        });
        
        rutInput.addEventListener('blur', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    }
    
    function agregarEnfermedad() {
        const enfermedad = enfermedadInput.value.trim();
        if (enfermedad && !enfermedades.includes(enfermedad)) {
            enfermedades.push(enfermedad);
            actualizarListaEnfermedades();
            enfermedadInput.value = '';
            enfermedadInput.focus();
        }
    }
    
    function agregarAlergia() {
        const alergia = alergiaInput.value.trim();
        if (alergia && !alergias.includes(alergia)) {
            alergias.push(alergia);
            actualizarListaAlergias();
            alergiaInput.value = '';
            alergiaInput.focus();
        }
    }
    
    function actualizarListaEnfermedades() {
        listaEnfermedades.innerHTML = '';
        enfermedades.forEach((enfermedad, index) => {
            const item = document.createElement('div');
            item.className = 'lista-item';
            item.innerHTML = `
                <span class="lista-item-text">${enfermedad}</span>
                <button type="button" class="btn-eliminar-item" onclick="eliminarEnfermedad(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            listaEnfermedades.appendChild(item);
        });
        enfermedadesHidden.value = enfermedades.join(',');
    }
    
    function actualizarListaAlergias() {
        listaAlergias.innerHTML = '';
        alergias.forEach((alergia, index) => {
            const item = document.createElement('div');
            item.className = 'lista-item';
            item.innerHTML = `
                <span class="lista-item-text">${alergia}</span>
                <button type="button" class="btn-eliminar-item" onclick="eliminarAlergia(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            listaAlergias.appendChild(item);
        });
        alergiasHidden.value = alergias.join(',');
    }
    
    window.eliminarEnfermedad = function(index) {
        enfermedades.splice(index, 1);
        actualizarListaEnfermedades();
    };
    
    window.eliminarAlergia = function(index) {
        alergias.splice(index, 1);
        actualizarListaAlergias();
    };
    
    agregarEnfermedadBtn.addEventListener('click', agregarEnfermedad);
    agregarAlergiaBtn.addEventListener('click', agregarAlergia);
    
    enfermedadInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            agregarEnfermedad();
        }
    });
    
    alergiaInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            agregarAlergia();
        }
    });
    
    {% if paciente.enfermedades_preexistentes %}
        enfermedades = [{% for enfermedad in paciente.get_enfermedades_list %}'{{ enfermedad }}'{% if not forloop.last %},{% endif %}{% endfor %}];
        actualizarListaEnfermedades();
    {% endif %}
    
    {% if paciente.alergias %}
        alergias = [{% for alergia in paciente.get_alergias_list %}'{{ alergia }}'{% if not forloop.last %},{% endif %}{% endfor %}];
        actualizarListaAlergias();
    {% endif %}
});
</script>
{% endblock %}