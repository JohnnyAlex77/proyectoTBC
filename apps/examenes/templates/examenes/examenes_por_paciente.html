<!-- apps/examenes/templates/examenes/examenes_por_paciente.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Exámenes de {{ paciente.nombre }} - Sistema TBC{% endblock %}

{% block content %}

<div class="container-fluid py-4">
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
<div>
<h1 class="h3 text-gray-800">
<i class="fas fa-microscope me-2"></i>Exámenes Bacteriológicos
</h1>
<!-- CORRECCIÓN: Acceso correcto según el modelo -->
<p class="text-muted mb-0">
    Paciente: <strong>{{ paciente.nombre }}</strong> 
    - RUT: {{ paciente.rut }}
    - Edad: {{ paciente.get_edad }} años
</p>
</div>

<div class="btn-group">
<a href="{% url 'examenes:crear_examen' %}" class="btn btn-primary">
    <i class="fas fa-plus me-2"></i>Nuevo Examen
</a>
<a href="{% url 'examenes:lista_examenes' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>Volver a Exámenes
</a>
</div>
</div>

<!-- Lista de Exámenes -->
<div class="card shadow">
<div class="card-body">
  {% if examenes %}
<div class="table-responsive">
<table class="table table-hover">
<thead class="table-light">
<tr>
<th>Tipo Examen</th>
<th>Muestra</th>
<th>Fecha Toma</th>
<th>Fecha Resultado</th>
<th>Resultado</th>
<th>Sensibilidad</th>
<th>Acciones</th>
</tr>
</thead>
<tbody>
{% for examen in examenes %}
<tr>
<td>
<span class="badge bg-info">{{ examen.get_tipo_examen_display }}</span>
</td>
<td>{{ examen.get_tipo_muestra_display }}</td>
<td>{{ examen.fecha_toma_muestra|date:"d/m/Y"}}</td>
<td>
{% if examen.fecha_resultado %}
{{ examen.fecha_resultado|date:"d/m/Y" }} 
{% else %}
<span class="text-muted">Pendiente</span>
{% endif %}
</td>
<td>
{% if examen.resultado == 'POSITIVO' %}
<span class="badge bg-danger">{{ examen.get_resultado_display }}</span>
{% elif examen.resultado == 'NEGATIVO' %}
<span class="badge bg-success">{{ examen.get_resultado_display }}</span>
{% elif examen.resultado == 'PENDIENTE' %}
<span class="badge bg-warning">{{ examen.get_resultado_display }}</span>
{% else %}
<span class="badge bg-secondary">{{ examen.get_resultado_display }}</span>
{% endif %}
</td>
<td>
{% if examen.sensibilidad %}
<span class="badge bg-dark">{{ examen.get_sensibilidad_display }}</span>
{% else %}
<span class="text-muted">-</span>
{% endif %}
</td>
<td>
<div class="btn-group btn-group-sm">
<a href="{% url 'examenes:detalle_examen' examen.id %}"
class="btn btn-outline-primary" title="Ver detalle">
<i class="fas fa-eye"></i>
</a>
<a href="{% url 'examenes:editar_examen' examen.id %}"
class="btn btn-outline-warning" title="Editar">
<i class="fas fa-edit"></i>
</a>

{% if request.user.is_superuser or request.user.usuariosusuario.es_administrador %}
<a href="{% url 'examenes:eliminar_examen' examen.id %}"
class="btn btn-outline-danger" title="Eliminar">
<i class="fas fa-trash"></i>
</a>
{% endif %}
</div>
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

{% else %}
<div class="text-center py-5">
<i class="fas fa-microscope fa-3x text-muted mb-3"></i>
<h4 class="text-muted">No hay exámenes registrados</h4>
<p class="text-muted">Este paciente no tiene exámenes bacteriológicos registrados.</p>
<a href="{% url 'examenes:crear_examen' %}" class="btn btn-primary mt-2">
<i class="fas fa-plus me-2"></i>Registrar Primer Examen
</a>
</div>
{% endif %}
</div>
</div>
</div>
{% endblock %}